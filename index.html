<!DOCTYPE html>
<html>
<head>
    <title>Proof of Concept</title>
    <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0"> 
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
    <style>
    #map { height: 300px; }
    </style>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
    <script src="tileUtils.js"></script>
    <script src="bulkDownload.js"></script>
    <script src="cordova.js"></script>
    <script type="text/javascript">

//sloppy global but ok for now
var MAP;
var BASE_MAPS = [];
var TILE_LAYER;
var FILESYSTEM;

function clearTiles(callback) {
    FILESYSTEM.root.getDirectory('tiles', {create: true},
	    function(dir) { //success
	       dir.removeRecursively(
                function() { callback(); }, 
                function(){ alert("Error deleting!"); }
            );
	    }, 
	    function() { alert("Error deleting tiles")} //fail
    );
}

function tileFormat4FS(fileSystem) {
    var rootDir = fileSystem.root.fullPath;
    if (rootDir[rootDir.length-1] != '/') { rootDir += '/'; }
    
    var mapID = localStorage["MAPBOX_ID"];
    if (mapID) {
      return rootDir + 'tiles/' + mapID + '/{z}/{x}/{y}.png';
    } else {
        return null;
    }   
}

function reloadMap() {
    if (!MAP) {
        MAP = L.map('map', {'minZoom': 3, 'maxZoom': 17}).setView([38.255, -85.73], 15);
    }

    if (TILE_LAYER) { //clear out old layer if exists
        MAP.removeLayer(TILE_LAYER);
        TILE_LAYER = null;
    }

    BASE_MAPS = [];
    
    format = tileFormat4FS(FILESYSTEM);
    if (!format) { return; }
    
    TILE_LAYER = L.tileLayer(format, {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; MapBox',
        minZoom: 3,
        maxZoom: 17
    })
    BASE_MAPS.push(TILE_LAYER);
    TILE_LAYER.addTo(MAP);
    
    L.control.layers(BASE_MAPS, []).addTo(MAP);
}

$(document).ready(function() {
    //Some bookkeeping code for mapbox id
    $("#mapbox_id")
    .val(localStorage["MAPBOX_ID"])
    .off("change")
    .on("change", function() { localStorage["MAPBOX_ID"] = $(this).val(); });

    //Real page setup on phonegap initialization
	$(document).off("deviceready").on("deviceready", function() {
	
		window.requestFileSystem(
		    LocalFileSystem.PERSISTENT, 0, 
		    function(fs) { //success
		        FILESYSTEM = fs; //set global - sloppy, I know
		        reloadMap();
		    },
		    function() { alert("Failure!"); } //filesystem failure
		);
		
		$("#clear").off("click").on("click", function() {
		    clearTiles(function(){ reloadMap(); alert("Tiles cleared successfully"); });
		});

	    $("#download").off("click").on("click", function() {
	        var mapID = localStorage["MAPBOX_ID"];
	        if (mapID) {
	           bulkDownload(
	               pyramid(mapID, 38.255, -85.73, {'minZoom':14, 'maxZoom':16}), //tile urls
	               'tiles',
	               function() { alert("Download successful!"); reloadMap(); }
	           );
	        } else {
	           alert("Enter a MapBox Map ID");
	        }
	    });
	}); 
});    

    </script>
</head>
<body> 
    <div id="map_wrapper"><div id="map"></div></div>
    <div style="text-align:center;margin-top:20px;">
      MapBox ID: <input id="mapbox_id" type="text" size="30" placeholder="e.g. examples.map-yr0njcqy"/>
      <br /><br />
      <button id="download" style="padding:20px;">Download Tiles</button>
      <button id="clear" style="padding:20px;">Clear Tiles</button>
    </div>

<script src="http://worker.silviaterra.com:8081/target/target-script-min.js#anonymous"></script>

</body>
</html>