<!DOCTYPE html>
<html>
<head>
    <title>Proof of Concept</title>
    <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0"> 
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
    <style>
    #map { height: 300px; }
    </style>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
    <script src="cordova.js"></script>
    <script type="text/javascript">

function downloadFile(url, target_fn) { //inspired by http://stackoverflow.com/questions/6417055/
  window.requestFileSystem(
    LocalFileSystem.PERSISTENT, 0, 
    function onFileSystemSuccess(fileSystem) {
      
      var rootDir = fileSystem.root.fullPath;
      if (rootDir[rootDir.length-1] != '/') { rootDir += '/'; }
      var fn = rootDir + target_fn;
      
      var fileTransfer = new FileTransfer();
      fileTransfer.download(encodeURI(url), fn,
        function(theFile) { 
            alert("download complete: " + theFile.toURL());
            $("#dl_img").attr("src", theFile.toURL()); 
        },
        function(error) { alert("download error code: " + error.code); }
      );    
    },
    
    function() { alert("Failure!"); } //filesystem failure
  );
};

$(document).ready(function() {
    var map = L.map('map', {'maxZoom': 17}).setView([38.255, -85.73], 15);
	L.tileLayer('file:///home/max/tiles/{z}/{x}/{y}.png', {
	    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; MapBox',
	    maxZoom: 18
	}).addTo(map);
	
	$(document).off("deviceready").on("deviceready", function() {
	  $("#download").off("click").on("click", function() {
	    downloadFile("http://silviaterra.com/static/images/circle_logo_backgrd_match.png", "newfile.png");
	  });
	}); 
});    

    </script>
</head>
<body> 
    <div id="map"></div>
    <div style="text-align:center;margin-top:20px;">
      <button id="download" style="font-size:200;padding:20px;">Download</button>
    </div>
    <img id="dl_img" />
    
    <!-- DEBUG SCRIPT -->
    <script src="http://worker.silviaterra.com:8081/target/target-script-min.js#anonymous"></script>
    
</body>
</html>