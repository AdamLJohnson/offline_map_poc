<!DOCTYPE html>
<html>
<head>
    <title>Proof of Concept</title>
    <meta name="viewport" content="height=device-height,width=device-width,initial-scale=1.0,maximum-scale=1.0"> 
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
    <style>
    #map { height: 300px; }
    </style>
    
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
    <script src="cordova.js"></script>
    <script type="text/javascript">

//sloppy global but ok for now
var FILESYSTEM;

function clearTiles(callback) {
    FILESYSTEM.getDirectory('tiles', {},
	    function(dir) { //success
	       dir.removeRecursively(
                function() { callback(); }, 
                function(){ alert("Error deleting!"); }
            );
	    }, 
	    function() { alert("Error deleting tiles")} //fail
    );
}

function downloadFile(url, targetFn) { //inspired by http://stackoverflow.com/questions/6417055/
  window.requestFileSystem(
    LocalFileSystem.PERSISTENT, 0, 
    function(fileSystem) { //success
        var rootDir = fileSystem.root.fullPath;
        if (rootDir[rootDir.length-1] != '/') { rootDir += '/'; }
        var fn = rootDir + targetFn;
      
        var fileTransfer = new FileTransfer();
        fileTransfer.download(encodeURI(url), fn,
            function(theFile) { $("#dl_img").attr("src", theFile.toURL()); },
            function(error) { alert("download error code: " + error.code); }
        );    
    },
    function() { alert("Failure!"); } //filesystem failure
  );
};

function initMap(tile_url_format) {
    var map = L.map('map', {'maxZoom': 17}).setView([38.255, -85.73], 15);
    L.tileLayer(tile_url_format, {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; MapBox',
        maxZoom: 18
    }).addTo(map);
}

$(document).ready(function() {
    //Some bookkeeping code for mapbox id
    $("#mapbox_id")
    .val(localStorage["MAPBOX_ID"])
    .off("change")
    .on("change", function() { localStorage["MAPBOX_ID"] = $(this).val(); });

    //Real page setup on phonegap initialization
	$(document).off("deviceready").on("deviceready", function() {
	
		window.requestFileSystem(
		    LocalFileSystem.PERSISTENT, 0, 
		    function(fs) { //success
		        FILESYSTEM = fs; //set global - sloppy, I know
		        var rootDir = fs.root.fullPath;
		        if (rootDir[rootDir.length-1] != '/') { rootDir += '/'; }
		        initMap(rootDir + 'tiles/{z}/{x}/{y}.png');
		    },
		    function() { alert("Failure!"); } //filesystem failure
		);

	    $("#download").off("click").on("click", function() {
	        var mapID = localStorage["MAPBOX_ID"];
	        if (mapID) {
	           downloadFile(
	               'http://api.tiles.mapbox.com/v3/' + mapID + '/15/8580/12610.png',
	               'tiles/15/8580/12610.png'
	           );
	        } else {
	           alert("Enter a MapBox Map ID");
	        }
	    });
	}); 
});    

    </script>
</head>
<body> 
    <div id="map"></div>
    <div style="text-align:center;margin-top:20px;">
      MapBox ID: <input id="mapbox_id" type="text" size="50" placeholder="e.g. examples.map-yr0njcqy"/>
      <br /><br />
      <button id="download" style="font-size:200;padding:20px;">Download Tiles</button>
    </div>
    <img id="dl_img" />
    
    <!-- DEBUG SCRIPT -->
    <script src="http://worker.silviaterra.com:8081/target/target-script-min.js#anonymous"></script>
    
</body>
</html>